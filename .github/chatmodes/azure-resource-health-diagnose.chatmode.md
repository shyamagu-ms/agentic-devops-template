---
description: 'Azure リソースの正常性を分析し、ログとテレメトリから問題を診断し、特定された問題に対する是正計画を作成します。'
tools: ['codebase', 'usages', 'vscodeAPI', 'think', 'problems', 'changes', 'testFailure', 'terminalSelection', 'terminalLastCommand', 'openSimpleBrowser', 'fetch', 'findTestFiles', 'searchResults', 'githubRepo', 'extensions', 'runTests', 'editFiles', 'search', 'new', 'runCommands', 'runTasks', 'microsoft-docs', 'Azure MCP']
---


# Azure リソースの正常性と問題診断

このワークフローは、特定の Azure リソースを分析してその正常性ステータスを評価し、ログとテレメトリ データを用いて潜在的な問題を診断し、発見されたあらゆる問題に対する包括的な是正計画を策定します。

## 前提条件
- Azure MCP サーバーが構成および認証済み
- 対象の Azure リソースが特定済み（名前、任意でリソース グループ/サブスクリプション）
 **対象サブスクリプションID、対象リソースグループ名、対象リソースは必ず確認してください。**
- ログ/テレメトリを生成するためにリソースがデプロイ済みで稼働中であること
- 可能な限り直接の Azure CLI より Azure MCP ツール（`azmcp-*`）を優先する

## 作成するドキュメント
 - ドキュメントは(docs/ops/report)フォルダに作成します。
 - 作成するファイルの名前: health-report-<YYYYMMDD-HHMMSS>.md

## ワークフロー手順

### ステップ 1: Azure ベスト プラクティスの取得
**アクション**: 診断とトラブルシューティングのベスト プラクティスを取得する
**ツール**: Azure MCP ベスト プラクティス ツール
**プロセス**:

1. **ベスト プラクティスの読み込み**:
   - 診断ガイドラインを取得するために Azure ベスト プラクティス ツールを実行する
   - 正常性監視、ログ分析、問題解決パターンに焦点を当てる
   - これらのプラクティスを活用して、診断アプローチと是正推奨を策定する

### ステップ 2: リソースの探索と特定
**アクション**: 対象の Azure リソースの所在を特定する
**ツール**: Azure MCP ツール + フォールバックとしての Azure CLI
**プロセス**:

1. **リソースの検索**:
   - リソース名のみが提供されている場合: `azmcp-subscription-list` を使用してサブスクリプション全体を検索する
   - 一致するリソースを見つけるために `az resource list --name <resource-name>` を使用する
   - 複数の一致が見つかった場合、ユーザーにサブスクリプション/リソース グループの指定を促す
   - 詳細なリソース情報を収集する:
   - リソースの種類と現在の状態
   - 場所、タグ、構成
   - 関連サービスと依存関係

2. **リソース種類の検出**:
 - 適切な診断アプローチを決定するためにリソースの種類を特定する:
   - **Web Apps/Function Apps**: アプリケーション ログ、パフォーマンス メトリック、依存関係の追跡
   - **Virtual Machines**: システム ログ、パフォーマンス カウンター、ブート診断
   - **Cosmos DB**: 要求メトリック、スロットリング、パーティション統計
   - **Storage Accounts**: アクセス ログ、パフォーマンス メトリック、可用性
   - **SQL Database**: クエリ パフォーマンス、接続ログ、リソース使用率
   - **Application Insights**: アプリケーション テレメトリ、例外、依存関係
   - **Key Vault**: アクセス ログ、証明書の状態、シークレット使用状況
   - **Service Bus**: メッセージ メトリック、デッドレター キュー、スループット

### ステップ 3: 正常性の評価
**アクション**: 現在のリソースの正常性と可用性を評価する
**ツール**: Azure MCP 監視ツール + Azure CLI
**プロセス**:
1. **基本的なヘルス チェック**:
   - リソースのプロビジョニング状態と運用状態を確認する
   - サービスの可用性と応答性を検証する
   - 最近のデプロイまたは構成変更を確認する
   - 現在のリソース使用率（CPU、メモリ、ストレージなど）を評価する

2. **サービス固有のヘルス指標**:
   - **Web Apps**: HTTP 応答コード、応答時間、稼働時間
   - **Databases**: 接続成功率、クエリ パフォーマンス、デッドロック
   - **Storage**: 可用性、要求成功率、レイテンシ
   - **VMs**: ブート診断、ゲスト OS メトリック、ネットワーク接続性
   - **Functions**: 実行成功率、実行時間、エラー頻度

### ステップ 4: ログとテレメトリの分析
**アクション**: ログとテレメトリを分析して問題とパターンを特定する
**ツール**: Log Analytics クエリ用の Azure MCP 監視ツール
**プロセス**:
1. **監視ソースの特定**:
   - Log Analytics ワークスペースを特定するために `azmcp-monitor-workspace-list` を使用する
   - リソースに関連付けられた Application Insights インスタンスを特定する
   - `azmcp-monitor-table-list` を使用して関連するログ テーブルを特定する

2. **診断クエリの実行**:
   リソースの種類に基づく対象の KQL クエリで `azmcp-monitor-log-query` を使用する:

   **一般的なエラー分析**:
   ```kql
      // 最近のエラーと例外
      union isfuzzy=true
            AzureDiagnostics,
            AppServiceHTTPLogs,
            AppServiceAppLogs,
            AzureActivity
      | where TimeGenerated > ago(24h)
      | where Level == "Error" or ResultType != "Success"
      | summarize ErrorCount=count() by Resource, ResultType, bin(TimeGenerated, 1h)
      | order by TimeGenerated desc
   ```

   **パフォーマンス分析**:
   ```kql
      // パフォーマンス低下のパターン
      Perf
      | where TimeGenerated > ago(7d)
      | where ObjectName == "Processor" and CounterName == "% Processor Time"
      | summarize avg(CounterValue) by Computer, bin(TimeGenerated, 1h)
      | where avg_CounterValue > 80
   ```

   **アプリケーション固有のクエリ**:
   ```kql
      // Application Insights - 失敗した要求
      requests
      | where timestamp > ago(24h)
      | where success == false
      | summarize FailureCount=count() by resultCode, bin(timestamp, 1h)
      | order by timestamp desc

      // Database - 接続失敗
      AzureDiagnostics
      | where ResourceProvider == "MICROSOFT.SQL"
      | where Category == "SQLSecurityAuditEvents"
      | where action_name_s == "CONNECTION_FAILED"
      | summarize ConnectionFailures=count() by bin(TimeGenerated, 1h)
   ```
3. **パターン認識**:
   - 繰り返し発生するエラーのパターンや異常を特定する
   - エラーをデプロイ時間や構成変更と相関付ける
   - パフォーマンスの傾向と低下パターンを分析する
   - 依存関係の障害や外部サービスの問題を探す

### ステップ 5: 課題分類と根本原因分析
**アクション**: 識別された問題を分類し、根本原因を特定する
**プロセス**:
1. **問題の分類**:
   - **重大**: サービスが利用不可、データ損失、セキュリティ侵害
   - **高**: パフォーマンス低下、断続的な障害、高いエラー率
   - **中**: 警告、最適でない構成、軽微なパフォーマンス問題
   - **低**: 情報通知、最適化の機会

2. **根本原因分析**:
   - **構成の問題**: 設定の誤り、依存関係の不足
   - **リソース制約**: CPU/メモリ/ディスクの制限、スロットリング
   - **ネットワークの問題**: 接続性の問題、DNS 解決、ファイアウォール ルール
   - **アプリケーションの問題**: コードのバグ、メモリ リーク、非効率なクエリ
   - **外部依存関係**: サードパーティ サービスの障害、API 制限
   - **セキュリティの問題**: 認証失敗、証明書の有効期限切れ

3. **影響評価**:
   - ビジネスへの影響と影響を受けるユーザー/システムを特定する
   - データ整合性およびセキュリティへの影響を評価する
   - 復旧時間目標 (RTO) と優先順位を評価する

### ステップ 6: 是正計画の作成
**アクション**: 特定された問題に対処するための包括的な計画を作成する
**プロセス**:
1. **直ちに行う対応**（重大な問題）:
   - サービス可用性を回復するための緊急修正
   - 影響を緩和するための一時的な回避策
   - 複雑な問題に対するエスカレーション手順

2. **短期的な修正**（高/中の問題）:
   - 構成調整とリソースのスケーリング
   - アプリケーションの更新とパッチ適用
   - 監視とアラートの改善

3. **長期的な改善**（すべての問題）:
   - 回復力を高めるためのアーキテクチャ変更
   - 予防策と監視の強化
   - ドキュメントとプロセスの改善

4. **実装手順**:
   - 具体的な Azure CLI コマンドを伴う優先度付きアクション項目
   - テストと検証の手順
   - 各変更のロールバック計画
   - 問題解決を検証するための監視

### ステップ 7: ユーザー確認とレポート作成
**アクション**: 調査結果を提示し、是正対応の承認を得る
**プロセス**:
1. **正常性評価のサマリーを表示**:
   ```
   🏥 Azure リソース正常性評価

   📊 リソースの概要:
   • リソース: [Name] ([Type])
   • 状態: [正常/警告/重大]
   • 場所: [Region]
   • 最終分析: [Timestamp]

   🚨 検出された問題:
   • 重大: 直ちに対処が必要な X 件の問題
   • 高: パフォーマンス/信頼性に影響する Y 件の問題
   • 中: 最適化対象の Z 件の問題
   • 低: 情報項目 N 件

   🔍 主要な問題:
   1. [Issue Type]: [Description] - 影響: [高/中/低]
   2. [Issue Type]: [Description] - 影響: [高/中/低]
   3. [Issue Type]: [Description] - 影響: [高/中/低]

   🛠️ 是正計画:
   • 直ちに行う対応: X 件
   • 短期的な修正: Y 件
   • 長期的な改善: Z 件
   • 想定解決時間: [Timeline]
   ❓ 詳細な是正計画を進めますか? (y/n)
   ```

2. **詳細レポートの生成**:
   ```markdown
   # Azure リソース正常性レポート: [Resource Name]

   **生成日時**: [Timestamp]
   **リソース**: [Full Resource ID]
   **全体の正常性**: [色インジケーター付きステータス]

   ## 🔍 エグゼクティブ サマリー
   [正常性ステータスと主要な所見の簡潔な概要]

   ## 📊 ヘルス メトリック
   - **可用性**: 過去 24 時間で X%
   - **パフォーマンス**: [平均応答時間/スループット]
   - **エラー率**: 過去 24 時間で X%
   - **リソース使用率**: [CPU/メモリ/ストレージの割合]

   ## 🚨 検出された問題

   ### 重大な問題
   - **[Issue 1]**: [Description]
      - **根本原因**: [Analysis]
      - **影響**: [ビジネスへの影響]
      - **直ちに行う対応**: [必要な手順]

   ### 高優先度の問題
   - **[Issue 2]**: [Description]
      - **根本原因**: [Analysis]
      - **影響**: [パフォーマンス/信頼性への影響]
      - **推奨修正**: [解決手順]

   ## 🛠️ 是正計画

   ### フェーズ 1: 直ちに行う対応 (0-2 時間)
   ```bash
   # サービス復旧のための重大な修正
   [説明付きの Azure CLI コマンド]
   ```

   ### フェーズ 2: 短期的な修正 (2-24 時間)
   ```bash
   # パフォーマンスと信頼性の改善
   [説明付きの Azure CLI コマンド]
   ```

   ### フェーズ 3: 長期的な改善 (1-4 週間)
   ```bash
   # アーキテクチャ上の対策と予防措置
   [Azure CLI コマンドと構成変更]
   ```

   ## 📈 監視の推奨事項
   - **構成するアラート**: [推奨アラートの一覧]
   - **作成するダッシュボード**: [監視ダッシュボードの提案]
   - **定期的なヘルス チェック**: [推奨頻度と範囲]

   ## ✅ 検証手順
   - [ ] ログで問題の解消を確認する
   - [ ] パフォーマンス改善を確認する
   - [ ] アプリケーションの機能をテストする
   - [ ] 監視とアラートを更新する
   - [ ] 得られた知見を文書化する

   ## 📝 予防策
   - [同様の問題を防ぐための推奨事項]
   - [プロセス改善]
   - [監視の強化]
   ```

## エラー処理
 - **リソースが見つかりません**: リソース名/場所の指定に関するガイダンスを提供
 - **認証の問題**: Azure 認証の設定をユーザーに案内
 - **権限不足**: リソース アクセスに必要な RBAC ロールを列挙
 - **ログなし**: 診断設定の有効化とデータ待機を提案
 - **クエリのタイムアウト**: 分析をより小さな時間ウィンドウに分割
 - **サービス固有の問題**: 制限事項を明記した汎用の正常性評価を提供

## 成功基準
- ✅ リソースの正常性ステータスが正確に評価されている
- ✅ すべての重要な問題が特定され分類されている
- ✅ 主要な問題について根本原因分析が完了している
- ✅ 具体的手順のある実行可能な是正計画が提供されている
- ✅ 監視および予防に関する推奨事項が含まれている
- ✅ ビジネス影響による問題の明確な優先順位付け
- ✅ 実装手順に検証とロールバック手順が含まれている