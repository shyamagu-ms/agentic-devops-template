# Azure Functions (.NET) 開発・運用ガイドライン
本ドキュメントは、Azure Functions を .NET8 で設計方針を示します。
対象は関数アプリの設計、クラス構成、セキュリティ/構成管理、監視/ロギングです。

---

## 1. アーキテクチャ設計・クラス構成ガイド

### 1-1. 単一責任の関数とクラス
- 原則（推奨）: 各関数は一度に一つのタスクのみを実行する単一責任で設計します。
- 分割（推奨）: 複雑な処理は複数関数に分割し、必要に応じて Durable Functions で連携します。
- クラス（推奨）: クラスも単一責任を徹底し、機能ごとに分割します。

### 1-2. 関数アプリとモジュールの分割
- グルーピング（推奨）: 関連機能の複数 Function は同一 Function App にまとめます。
- 分離（推奨）: スケール要件やセキュリティ境界が異なる場合は Function App を分離します。例: 社内向けと外部公開向けを別アプリに分割。
- 本番と検証コード（必須）: テスト用途の関数を本番アプリに混在させない。Function App を分けて干渉を防止します。

### 1-3. レイヤードアーキテクチャ
- 分割（推奨）: プレゼンテーション層（Function トリガー）、ビジネスロジック層、データアクセス層に分割。
- 依存方向（必須）: 上位層から下位層への一方向依存のみ許可。相互参照を禁止。
- 結合度（推奨）: クリーンアーキテクチャ/依存性逆転を取り入れ、インターフェース越しの実装で密結合を回避。

### 1-4. クラスファイル構成
- 1クラス1ファイル（原則）: ファイル名＝クラス名。
- 名前空間（推奨）: モジュール（ドメイン）単位で整理。
- 共有ライブラリ（推奨）: 複数 Function で利用する共通コードはクラスライブラリとして分離し共有。Function 本体は簡潔に保つ。

### 1-5. 依存性の注入（DI）
- DI 利用（推奨）: サービス/リポジトリ等は DI コンテナに登録し、Function から注入して利用。
- 登録場所（推奨）: Startup（例: FunctionsStartup を継承し Configure で登録）等、フレームワークが提供する拡張ポイントで定義。
- 効果: 依存関係の明示化、モック差し替え容易化、モジュール性・テスタビリティ向上。

### 1-6. リソースと性能設計
- ストレージ（原則）: Function App ごとに専用の Azure Storage アカウントを割り当て、アプリ間で共有しない。
- スケール分離（推奨）: 高負荷な関数は別アプリに分離してスケール/メモリを独立管理。
- ネットワーク/プラン（推奨）: VNet 統合や Premium プラン利用時は帯域・要件に応じてアプリ設計を最適化。

---

## 2. セキュリティと構成管理

### 2-1. 機密情報の管理（必須）
- 禁止: シークレットのコード直書き。
- 管理: Azure Key Vault に格納し、Function App のマネージド ID で参照。
- 設定: Key Vault のアクセス権をマネージド ID に付与し、アプリ設定で Key Vault 参照を用いて環境変数として取得。
- 分離: 環境ごとにシークレットを分離管理。

### 2-2. 認証・認可の設定
- 社内限定（方針）: HTTP トリガーは承認レベル Function とし、関数キー必須。
- 公開 API（方針）: 前段に API Management を配置し、Function 側は Anonymous。認証・認可はゲートウェイで実施。
- CORS（必須）: 必要なドメインのみ許可する最小権限の設定。

### 2-3. 通信とネットワーク
- HTTPS（必須）: 「常に HTTPS を使用」を有効化し TLS 経路のみ許可。外部サービスも極力 HTTPS を利用。
- プライベートアクセス（推奨）: VNet 統合で内部リソースへはプライベート経路を使用（Premium/Dedicated 等）。
- アクセス制御（推奨）: IP 制限や Azure Firewall/サービスタグでアウトバウンド/インバウンドを管理。

### 2-4. 構成管理とパラメータ
- アプリ設定（必須）: 接続文字列や可変パラメータはアプリ設定に保持。コードへのリテラル埋め込み禁止。
- 環境差分（推奨）: Azure DevOps 変数や App Configuration、デプロイ時のパラメータで切替え。
- 禁止: #if DEBUG 等のコード分岐で環境を切替える実装。
- IaC（推奨）: ARM/Bicep にアプリ設定・診断ログ等を含め一元管理。
- スロット設定（必須）: 機密情報を含むアプリ設定は「スロット設定」を有効化しスロット間で漏洩防止。

### 2-5. プラットフォーム機能のセキュリティ設定
- FTP（必須）: FTP アクセスは無効。FTPS/FTP を外部公開しない。
- ポータル編集（必須）: 本番でのポータル編集は禁止。ローカル開発＋CI 経由でデプロイ。必要に応じて編集機能をロックダウン。
- 更新（推奨）: ランタイム/拡張機能の最新パッチを適用し、脆弱性対策を継続。

---

## 3. 監視・ロギング・運用

### 3-1. Application Insights の活用
- 有効化（必須）: Function App 作成時に Application Insights を有効化。
- 統合（社内標準）: Log Analytics ワークスペースと統合し社内標準のワークスペースに集約（「earth_IT_ログ標準」参照）。
- 収集内容: 実行ログ、依存関係、例外、パフォーマンスメトリック等。

### 3-2. ロギング方針
- ログレベル（推奨）:
  - 情報: 正常処理の重要ステップを記録
  - 警告: 想定内だが注意すべき事象
  - エラー: ハンドルした例外や失敗
- コンテキスト（推奨）: リクエスト ID、対象データ ID 等を含め、後分析を容易化。
- 分析（推奨）: Kusto Query Language (KQL) により Azure Portal の「ログ」で分析。
- PII/機密（必須）: 個人情報や機密データは出力しない。必要に応じてマスキング・要約を実施。

---

## 4. データアクセス

### 4-1. O/Rマッパー**Dapper**の活用
- O/Rマッパーとして Dapperを採用する
- 以下の公式情報などを fetch して読み込み理解してから使うこと
 - [公式サイト](https://github.com/DapperLib/Dapper)
 - [概要ドキュメント](https://learn.microsoft.com/ja-jp/archive/msdn-magazine/2016/may/data-points-dapper-entity-framework-and-hybrid-apps)

---
