# データベース設計ガイドライン (Azure SQL Database)

## スキーマとデータ設計

 - **論理データモデル**: アプリケーションで扱うエンティティ同士の関係を整理し、ER図にまとめます。設計書には主要なテーブルとそのカラム、データ型、制約を一覧表で示します。特に主キー（一意制約）や外部キー（参照整合性）は必ず明記し、データの一貫性を保証します。例えば「ユーザーテーブルと受注テーブルをユーザーIDでリレーションする（ユーザー削除時に履歴保持のため受注は残す）」等、ビジネスルールに基づいた制約を定義します。

 - **正規化とパフォーマンス**: データの重複や不整合を防ぐため基本的には正規化した設計としますが、読取り性能向上のために非正規化を許容する場合もあります。その際は、どのような冗長データを持たせ、更新時にどう整合性を保つかをドキュメント化します。インデックスについても、クエリ性能に直結するため設計段階で計画します。主キーには自動的にクラスタードインデックスが付きますが、検索頻度の高いカラムには追加のノンクラスタードインデックスを付与します。ただし過度なインデックスは更新性能を害するため、バランスを考慮します。設計書には、各テーブルごとに想定クエリとそれに対応するインデックス戦略を簡潔に記載します。

 - **ストアドプロシージャ等**: 基本的なCRUDはアプリケーション側で行う前提としつつ、複雑な集計や一括処理が必要な場合はデータベース内にストアドプロシージャやSQLスクリプトを用意することも検討します。その場合、どのような処理をDB側で実装するか、その入出力とロジック概要を設計書で説明します。トランザクション管理も留意し、必要に応じてトランザクション分離レベルやロックの方針を記載します。

## 初期データとマイグレーション

 - **初期データ投入**: システム稼働にあたり、マスターコードや管理者アカウントなど初期データの用意が必要な場合があります。設計書には、初期データ一覧（例: 都道府県マスタのコードと名称）を添付し、備考として「デプロイ後、InitializeData.sqlスクリプトを実行して登録」等の手順を示します。スクリプトはINSERT文の集合や、必要ならBULK INSERTの手順で作成します。特にAzure SQLの場合、デプロイパイプライン（Azure DevOps等）に初期データ投入ステップを組み込むこともできるため、インフラ担当者と協議して導入します。

 - **マイグレーション**: 開発から本番までDBスキーマが変更される可能性があるため、DDL変更を管理するマイグレーション手順も設計します。例えば、スキーマバージョン管理にEntity FrameworkやFlyway等のツールを使う場合は、その設定と運用指針を記載します。バージョンごとの変更SQLファイルを管理リポジトリに含め、デプロイ時に自動適用する流れを定義するとよいでしょう。

## クラウドサービスならではの考慮事項

 - **サービスプランとスケーリング**: Azure SQL Databaseを使用する場合、サービス層の選定（Basic/Standard/Premium または vCoreモデルのGenPurpose/BusinessCritical等）を設計時に検討します。予想負荷に応じて適切なプランを選びますが、将来的なスケールアウト/アップが容易にできる点がクラウドの利点です。設計書には「初期はGeneral Purpose S0プランで開始し、負荷増大時はS1へスケールアップ可能」といった見通しを記載しておきます。

 - **可用性とバックアップ**: Azure SQLは自動バックアップ機能があります。ビジネス要件に応じてポイントインタイムリストアや長期保存が必要なら、バックアップの保持期間を設定します（例: PITR 7日間、ロングタームバックアップ 1ヶ月など）。また、必要に応じてGeo冗長バックアップやフェールオーバーグループを有効化し、災害対策を講じます。これらの設定や利用するAzureリージョンも設計書に明記します。例えば「主リージョン: East Japan、DRリージョン: West Japan、フェールオーバー自動化: 適用」等です。

 - **セキュリティ（認証とネットワーク）**: Azure SQL DatabaseではAzure AD認証を積極的に利用し、データベースへの接続にはマネージドIDまたはAzure ADユーザーを用いる方針とします。これによりアプリケーション側に接続文字列のユーザー名/パスワードを持たせず、安全性を高められます。具体的には、アプリケーションにシステム割当てマネージドIDを付与し、Azure SQL上でそのIDに必要なDBロールを割り当てます。この設計によりSQL認証は基本無効化し、資格情報漏洩リスクを低減します（管理者用にブレークグラスアカウントを設ける場合は別途管理）。さらにネットワーク面ではファイアウォールルールやアクセス制御を設定し、許可したアプリケーションからしかDBに接続できないようにします。例えばAzure上のVNetサービスエンドポイントやプライベートリンクを使い、DBへのトラフィックを社内ネットワークに閉じる設計とします。

 - **接続と接続文字列管理**: アプリケーションからDBへの接続方式（ODBC/JDBC/ドライバ名など）とコネクションプールの設定を明示します。クラウドDBは接続確立コストが高いため、プールサイズやタイムアウトを適切に設定することが重要です。設計書には、「接続プール上限100、アイドルタイムアウト60秒、再試行ポリシー有り」等、パフォーマンスと安定性のバランスを考慮したパラメータを記載します。また接続文字列はキーボールト等安全な場所に格納し、アプリはそれを参照する構成とします（Managed Identity利用なら接続文字列中に資格情報を含めない）。
 